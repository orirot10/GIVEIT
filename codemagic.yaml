workflows:
  ios-appstore-signed:
    name: iOS App Store (Capacitor; signed)
    instance_type: mac_mini_m1
    max_build_duration: 60
    environment:
      node: 18
      xcode: latest
      cocoapods: default
      # ====== ערכים להתאמה ======
      vars:
        APP_SCHEME: "App"            # שם ה-Scheme ב-Xcode (Capacitor יוצר בד"כ "App")
        IOS_DIR: "frontend/ios/App"  # נתיב פרויקט iOS
        APPLE_TEAM_ID: "39WVDVZKGE"  # החלף ל-Team ID שלך אם שונה
      # ====== הוסף ב-Encrypted env ב-Codemagic ======
      # P12_BASE64           (base64 של AppleDistribution.p12)
      # P12_PASSWORD         (סיסמת ה-p12)
      # DIST_PROFILE_BASE64  (base64 של קובץ ה-.mobileprovision מסוג App Store)

    scripts:


      - name: Install deps (frontend)
        script: |
          cd frontend
          npm ci || npm i

      - name: Build web (auto-detect framework)
        script: |
          set -e
          cd frontend
          BUILD_OK=0
          WEB_OUT=""

          # 1) Vite
          if [ -f vite.config.ts ] || [ -f vite.config.js ] || npm ls vite --depth=0 >/dev/null 2>&1; then
            npx vite build && BUILD_OK=1
          fi
          # 2) CRA
          if [ $BUILD_OK -eq 0 ] && (npm ls react-scripts --depth=0 >/dev/null 2>&1); then
            npx react-scripts build && BUILD_OK=1
          fi
          # 3) Next.js
          if [ $BUILD_OK -eq 0 ] && (npm ls next --depth=0 >/dev/null 2>&1); then
            npx next build
            npx next export || true
            BUILD_OK=1
          fi
          # 4) Ionic
          if [ $BUILD_OK -eq 0 ] && (npx ionic -v >/dev/null 2>&1); then
            npx ionic build && BUILD_OK=1
          fi
          # 5) fallback ל-"npm run build"
          if [ $BUILD_OK -eq 0 ]; then
            if npm run -s build >/dev/null 2>&1; then
              npm run build && BUILD_OK=1
            fi
          fi

          if [ $BUILD_OK -eq 0 ]; then
            echo "No known web build. Add a 'build' script or use Vite/CRA/Next/Ionic."
            cat package.json || true
            exit 1
          fi

          # מציאת תיקיית פלט
          if [ -d dist ]; then WEB_OUT="dist"; fi
          if [ -d build ]; then WEB_OUT="build"; fi
          if [ -d out ];   then WEB_OUT="out";   fi
          [ -z "$WEB_OUT" ] && { echo "Could not detect build output (dist/build/out)."; exit 1; }

          echo "==> Web build at: $WEB_OUT"

          # עדכון webDir בקובץ הקפציטור
          if [ -f capacitor.config.json ]; then
            node -e "const fs=require('fs');const p='capacitor.config.json';const o=JSON.parse(fs.readFileSync(p));o.webDir='$WEB_OUT';fs.writeFileSync(p, JSON.stringify(o,null,2));console.log('Updated',p,'webDir=$WEB_OUT');"
          elif ls capacitor.config.* >/dev/null 2>&1; then
            sed -i.bak "s/webDir: *['\"][^'\"]*['\"]/webDir: '$WEB_OUT'/" capacitor.config.* || true
            echo "Attempted to set webDir='$WEB_OUT' in capacitor.config.*"
          else
            echo "WARN: No capacitor.config.* found in frontend"
          fi
      - name: Check required env
  script: |
    test -n "${P12_BASE64:-}" || { echo "P12_BASE64 missing"; exit 1; }
    test -n "${P12_PASSWORD:-}" || { echo "P12_PASSWORD missing"; exit 1; }
    test -n "${DIST_PROFILE_BASE64:-}" || { echo "DIST_PROFILE_BASE64 missing"; exit 1; }
    echo "All required env vars are present."

      - name: Ensure iOS platform exists & sync
        script: |
          cd frontend
          [ ! -d "ios" ] && npx cap add ios
          npx cap sync ios
          cd ios/App
          pod install --repo-update

      - name: Detect BUNDLE_ID from Xcode
        script: |
          cd $IOS_DIR
          BID=$(xcodebuild -showBuildSettings \
                -workspace "App.xcworkspace" \
                -scheme "$APP_SCHEME" -configuration Release \
                | grep -m1 PRODUCT_BUNDLE_IDENTIFIER | awk '{print $3}')
          [ -z "$BID" ] && { echo "Failed to detect PRODUCT_BUNDLE_IDENTIFIER"; exit 1; }
          echo "Detected BUNDLE_ID=$BID"
          echo "export BUNDLE_ID=$BID" >> $CM_ENV

      - name: Debug signing context
        script: |
          set -x
          security find-identity -p codesigning -v || true
          echo "BUNDLE_ID=${BUNDLE_ID:-unset}"
          echo "BUNDLE_ID_FROM_PROFILE=${BUNDLE_ID_FROM_PROFILE:-unset}"
          echo "PROV_NAME=${PROV_NAME:-unset}"
          echo "PROV_UUID=${PROV_UUID:-unset}"

      - name: Install certificates & provisioning profile (manual, robust)
        script: |
          set -euxo pipefail

          # ===== 0) בדיקות קיום ENV =====
          : "${P12_BASE64:?P12_BASE64 is missing}"
          : "${P12_PASSWORD:?P12_PASSWORD is missing}"
          : "${DIST_PROFILE_BASE64:?DIST_PROFILE_BASE64 is missing}"

          CERTS_DIR="$HOME/Library/MobileDevice/Certificates"
          PROFILES_DIR="$HOME/Library/MobileDevice/Provisioning Profiles"
          mkdir -p "$CERTS_DIR" "$PROFILES_DIR"

          # ===== 1) Normalize Base64 (מסיר CRLF אפשריים) =====
          # לפעמים ה-base64 מגיע עם שורות שבורות/CRLF. ננרמל לשורה אחת נקייה.
          echo "$P12_BASE64"         | tr -d '\r\n ' > /tmp/p12.b64
          echo "$DIST_PROFILE_BASE64"| tr -d '\r\n ' > /tmp/profile.b64

          # וידוא שהקבצים לא ריקים
          [ -s /tmp/p12.b64 ] || { echo "Empty P12_BASE64"; exit 1; }
          [ -s /tmp/profile.b64 ] || { echo "Empty DIST_PROFILE_BASE64"; exit 1; }

          # ===== 2) הכנת keychain (לעתים login נעול) =====
          KEYCHAIN="$HOME/Library/Keychains/login.keychain-db"
          security list-keychains -d user -s "$KEYCHAIN"
          # נסה לפתוח את ה-login keychain עם סיסמת המשתמש (ב־CI לרוב אין צורך; אם ייכשל נתעלם)
          security unlock-keychain -p "" "$KEYCHAIN" || true
          security set-keychain-settings -lut 21600 "$KEYCHAIN" || true

          # ===== 3) יבוא ה-p12 =====
          P12_PATH="$CERTS_DIR/dist.p12"
          base64 --decode /tmp/p12.b64 > "$P12_PATH"

          # ניסיון ראשון (codesign+security)
          set +e
          security import "$P12_PATH" -k "$KEYCHAIN" -P "$P12_PASSWORD" -A \
            -T /usr/bin/codesign -T /usr/bin/security
          IMPORT_RC=$?
          set -e
          if [ $IMPORT_RC -ne 0 ]; then
            echo "First import attempt failed (maybe wrong password?). Retrying without -A…"
            security import "$P12_PATH" -k "$KEYCHAIN" -P "$P12_PASSWORD"
          fi

          # ודא שיש זהויות חתימה זמינות
          security find-identity -p codesigning -v || true

          # ===== 4) התקנת ה-mobileprovision וחילוץ פרטים =====
          PROFILE_PATH="$PROFILES_DIR/profile.mobileprovision"
          base64 --decode /tmp/profile.b64 > "$PROFILE_PATH"

          PLIST_OUT="$PROFILES_DIR/profile.plist"
          /usr/bin/security cms -D -i "$PROFILE_PATH" > "$PLIST_OUT"

          # חילוץ מאפייני הפרופיל עם PlistBuddy
          PROV_NAME=$(/usr/libexec/PlistBuddy -c 'Print :Name' "$PLIST_OUT")
          PROV_UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' "$PLIST_OUT")
          APP_ID_NAME=$(/usr/libexec/PlistBuddy -c 'Print :AppIDName' "$PLIST_OUT") || true
          TEAM_ID=$(/usr/libexec/PlistBuddy -c 'Print :Entitlements:com.apple.developer.team-identifier' "$PLIST_OUT") || true
          BUNDLE_ID_IN_PROF=$(/usr/libexec/PlistBuddy -c 'Print :Entitlements:application-identifier' "$PLIST_OUT" | sed "s/^${TEAM_ID}\.//") || true

          echo "== Provisioning profile parsed =="
          echo "Name: $PROV_NAME"
          echo "UUID: $PROV_UUID"
          echo "Team: ${TEAM_ID:-unknown}"
          echo "Bundle ID (from profile): ${BUNDLE_ID_IN_PROF:-unknown}"
          echo "AppIDName: ${APP_ID_NAME:-unknown}"

          # נייצא לסביבה להמשך השלבים
          echo "export PROV_NAME=\"$PROV_NAME\"" >> $CM_ENV
          echo "export PROV_UUID=\"$PROV_UUID\"" >> $CM_ENV
          echo "export BUNDLE_ID_FROM_PROFILE=\"$BUNDLE_ID_IN_PROF\"" >> $CM_ENV

          echo "== Installed provisioning profiles =="
          ls -la "$PROFILES_DIR" || true
          /usr/libexec/PlistBuddy -c 'Print :UUID' "$PLIST_OUT" || true

          # ===== 5) בדיקת התאמה לבאנדל (אם כבר זיהינו קודם BUNDLE_ID) =====
          if [ -n "${BUNDLE_ID:-}" ] && [ -n "${BUNDLE_ID_IN_PROF:-}" ]; then
            if [ "$BUNDLE_ID" != "$BUNDLE_ID_IN_PROF" ]; then
              echo "WARNING: Detected BUNDLE_ID='$BUNDLE_ID' differs from profile bundle='$BUNDLE_ID_IN_PROF'"
              echo "This often causes signing failures. Make sure profile matches your Xcode target bundle id."
            fi
          fi

          # ===== 6) מתן הרשאות key partition (מונע prompted access ב-codesign) =====
          # שקט במידה ואין זהויות — לא קריטי
          for HASH in $(security find-identity -p codesigning -v | awk '/\) [0-9A-F]{40}/ {print $2}'); do
            security set-key-partition-list -S apple-tool:,apple: -s -k "" "$KEYCHAIN" -t private -Z "$HASH" || true
          done

      - name: Bump build number
        script: |
          cd $IOS_DIR
          NEW_BUILD_NUMBER=${CM_BUILD_ID:-1}
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $NEW_BUILD_NUMBER" "App/Info.plist" || true

      - name: Build (archive) with code signing
        script: |
          cd $IOS_DIR
          xcodebuild archive \
            -workspace "App.xcworkspace" \
            -scheme "$APP_SCHEME" \
            -configuration Release \
            -destination "generic/platform=iOS" \
            -archivePath "$CM_BUILD_DIR/App.xcarchive" \
            DEVELOPMENT_TEAM="$APPLE_TEAM_ID" \
            CODE_SIGN_STYLE=Manual \
            PROVISIONING_PROFILE_SPECIFIER="$PROV_UUID" \
            CODE_SIGNING_ALLOWED=YES CODE_SIGNING_REQUIRED=YES

      - name: Export signed .ipa (App Store)
        script: |
          cd $IOS_DIR
          # המיפוי דורש Name (לא UUID) — נשתמש ב-$PROV_NAME
          xcode-project export-ipa \
            --archive "$CM_BUILD_DIR/App.xcarchive" \
            --export-method app-store \
            --export-options "provisioningProfiles[$BUNDLE_ID]=$PROV_NAME"

    artifacts:
      - build/ios/ipa/*.ipa
      - $IOS_DIR/build/Build/Products/Release-iphoneos/*.app
      - $CM_BUILD_DIR/App.xcarchive
